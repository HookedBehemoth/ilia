# Ilia Implementation Details

The first thing that Ilia does is iterate through each process. For each process, it asks `ldr:dmnt` for a list of NSO images and iterates over that. It iterates over all the symbols in each NSO, searching for ones with `s_Table` in them. There is one of these symbols for every IPC interface, and it contains a function pointer that is used whenever an IPC message comes in for an object of that type.

After building this list of `s_Tables`, Ilia will obtain a list of each interface to sniff. Each process gets a set of 16 "pipes". Each interface to be sniffed is assigned a pipe from its process's pool. After the pipe is created, it will patch the process. The `injection_payload` is written into the process, overwriting the start of the NSO image. This area typically contains RTLD code which is only run on startup, and is therefore safe to overwrite as long as we keep the size of the payload small. The first 64 bytes of the injection payload are a list of offsets within the payload to the interception functions for each of the 16 possible pipes. The `s_Table` is overwritten with a pointer to the interception function corresponding to the assigned pipe ID.

When a message then comes in on that interface, the IPC server will use the overwritten `s_Table` function pointer and call our interception function. Since the injection payload is written in the `.text` section, it cannot contain any global variables. Instead, it uses the first few pages of the heap as storage. Sysmodules do not use the heap, so this is safe for us to use. The injection payload will check if this is the first time it has been called. If it is, it will connect to the `ilia` service and open an `ilia::IMessageWriter` for its pipe.

Once the `IMessageWriter` is opened, the interception function will write the request it's intercepting over the pipe, tunneling first the raw request, then the contents of input descriptors. It calls the original function that the `s_Table` pointed to (this pointer is obtained when the `IMessageWriter` is opened), then tunnels the raw response and contents of any output descriptors.
